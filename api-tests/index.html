<!--
  Button to login to Reddit, give permissions, and get subreddit information about a user
-->
<!DOCTYPE html>
<html>

<head>
  <script>
    const REDDIT_APP_ID = 'q5rIR3lqrwMirg'
    const REDDIT_APP_SECRET = 'r3ClSlbfmhiI2hYF05GAAqN8CU0jsg'  // TODO darci: should store more securely
    const REDDIT_APP_REDIRECT = 'http://localhost:3000'

    const REDDIT_SCOPE = 'mysubreddits'
    const REDDIT_STATE = 'reddit-oauth2'   // NOTE darci: maybe should be random, could use redirect URI
    
    const REDDIT_TERMINAL_URI = "http://localhost:3000"   // Where user will end when all is done

    handleRedirectURI();

    // Send user to authorization URL to get (mysubreddits) permission
    function tryUserAuth() {
      var auth_url = new URL('https://www.reddit.com/api/v1/authorize');
      auth_url.search = new URLSearchParams({
        client_id: REDDIT_APP_ID,
        response_type: 'code',
        state: REDDIT_STATE,
        redirect_uri: REDDIT_APP_REDIRECT,
        duration: 'temporary',
        scope: REDDIT_SCOPE
      });
      console.log(auth_url)

      // Once user accepts/declines, handleRedirectURI() is called
      window.location.href = auth_url
    }

    // Check if Reddit redirected user back to us
    function handleRedirectURI() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('state') == REDDIT_STATE) {
        if (code = urlParams.get('code')) {
          console.log(code)
          requestAccessToken(code)
        } else if (error = urlParams.get('error')) {
          console.log("Error: " + error)
          window.location.href = REDDIT_TERMINAL_URI
        }
      }
    }

    function requestAccessToken(code) {
      data = (new URLSearchParams({
        'grant_type': 'authorization_code',
        'code': code,
        'redirect_uri': REDDIT_APP_REDIRECT,
      })).toString();

      fetch('https://www.reddit.com/api/v1/access_token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(REDDIT_APP_ID + ":" + REDDIT_APP_SECRET),
          },
          body: data,
        }).then(status).then(json)
        .then((responseJSON) => {
          token = responseJSON.access_token
          console.log("token: " + token)
          tryGetCommunityInfo(token);
        }).catch(function (err) {
          console.log('Error: ' + err);
        });
    }

    // Get the user's community info
    function tryGetCommunityInfo(token) {
      if (token) {
        console.log(token)
        fetch('https://oauth.reddit.com' + '/subreddits/mine/subscriber', {
          method: 'GET',
          headers: {
            'Authorization': 'bearer ' + token,
          }
        }).then(status).then(json)
        .then(function (respJSON) {
          communities = respJSON["data"]["children"]
          console.log(communities)
          // Comment out below if you want to see subreddit list
          // TODO: store into database :D
          // window.location.href = REDDIT_TERMINAL_URI
        }).catch(function (err) {
          console.log('Error, Failed to get communities:', err)
        });
      }
    }

    function json(response) {
      return response.json();
    }

    function status(response) {
      if (response.status >= 200 && response.status < 300) {
        return Promise.resolve(response)
      } else {
        return Promise.reject(new Error(response.statusText))
      }
    }

  </script>
</head>

<body>
  <button onclick="tryUserAuth();">Get subreddits</button>
</body>

</html>